# =============================================================================
# SPhoto Paid Tier Instance (With Machine Learning)
# =============================================================================
# URL: photos.sphoto.arturf.ch
# Features: 200GB-1TB storage, full ML features (face recognition, smart search)
# =============================================================================

name: sphoto-paid

services:
  server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: sphoto-paid-server
    environment:
      - DB_URL=postgresql://sphoto:${DB_PASSWORD}@db:5432/sphoto
      - REDIS_HOSTNAME=redis
      # Use shared ML service for efficiency
      - MACHINE_LEARNING_URL=http://sphoto-ml:3003
    volumes:
      - ${UPLOAD_LOCATION:-./uploads}:/usr/src/app/upload
    depends_on:
      - db
      - redis
    restart: unless-stopped
    networks:
      - sphoto-net
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sphoto-paid.rule=Host(`photos.${DOMAIN}`)"
      - "traefik.http.routers.sphoto-paid.entrypoints=websecure"
      - "traefik.http.routers.sphoto-paid.tls.certresolver=le"
      - "traefik.http.services.sphoto-paid.loadbalancer.server.port=2283"

  db:
    image: ghcr.io/immich-app/postgres:16-vectorchord0.4.3-pgvectors0.2.0
    container_name: sphoto-paid-db
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=sphoto
      - POSTGRES_DB=sphoto
    volumes:
      - ./db:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - internal

  redis:
    image: valkey/valkey:9
    container_name: sphoto-paid-redis
    restart: unless-stopped
    networks:
      - internal

networks:
  sphoto-net:
    external: true
  internal:
